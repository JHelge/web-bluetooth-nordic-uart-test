<html>
<head>
  <title>Web-Bluetooth test with the Nordic UART service</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  background-color: #ffffff;
  font-family: "Helvetica", "Arial", sans-serif;
}

pre {
  font-family: monospace;
}

.output {
  background-color: #f0f0f0;
  border-radius: 0.75em;
  display: block;
  margin: 0.5em;
  padding: 0.5em;
}

#log {
  margin: .5em 0;
  white-space: pre-wrap;
}

#log:empty {
  display: none;
}

</style>
</head>
<body>

<h1>Using the Nordic UART service with Web-Bluetooth</h1>
<form>
  <button id="startNotifications">Connect</button>
  <button id="stopNotifications">Disconnect</button>
</form>

<h3>Log output</h3>
<div id="output" class="output">
  <pre id="log"></pre>
</div>

<script>

var NUS_SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
var NUS_TX_CHARACTERISTIC_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";
var NUS_RX_CHARACTERISTIC_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";

var gattServer;
var txCharacteristic;
var rxCharacteristic;


var Logger = {
  log: function(line) {
    document.querySelector('#log').textContent += line + '\n';
  },

  clearLog: function() {
    document.querySelector('#log').textContent = '';
  },
};


function onStartButtonClick() {
  let serviceUuid = NUS_SERVICE_UUID;
  let tx_characteristicUuid = NUS_TX_CHARACTERISTIC_UUID;
  let rx_characteristicUuid = NUS_RX_CHARACTERISTIC_UUID;

  log('Requesting Bluetooth Device...');
  navigator.bluetooth.requestDevice({filters: [{services: [serviceUuid]}]})
  .then(device => {
    log('Connecting to GATT Server...');
    return device.gatt.connect();
  })
  .then(server => {
    log('Getting Service...');
    return server.getPrimaryService(serviceUuid);
  })
  .then(service => {
    gattServer = service;
    log('Getting Characteristics...');
    return Promise.all([
      service.getCharacteristic(tx_characteristicUuid)
        .then(tx_characteristic => {
          txCharacteristic = tx_characteristic;
          return txCharacteristic.startNotifications().then(_ => {
            log('Notifications started');
            txCharacteristic.addEventListener('tx_characteristicvaluechanged', handleNotifications);
          });
        }),
      service.getCharacteristic(rx_characteristicUuid)
        .then(rx_characteristic => {
          rxCharacteristic = rx_characteristic;
          log('Rx charactersitic obtained');
        })
    ]);
  })
  .catch(error => {
    log('Argh! ' + error);
  });
}

function onStopButtonClick() {
  if (txCharacteristic) {
    txCharacteristic.stopNotifications()
    .then(_ => {
      log('Notifications stopped');
      txCharacteristic.removeEventListener('tx_characteristicvaluechanged', handleNotifications);
      gattServer.disconnect();
    })
    .catch(error => {
      log('Argh! ' + error);
    });
  }
}

function handleNotifications(event) {
  let value = event.target.value;
  // let a = [];
  // // Convert raw data bytes to hex values just for the sake of showing something.
  // // In the "real" world, you'd use data.getUint8, data.getUint16 or even
  // // TextDecoder to process raw data bytes.
  // for (let i = 0; i < value.byteLength; i++) {
  //   a.push('0x' + ('00' + value.getUint8(i).toString(16)).slice(-2));
  // }
  // log('> ' + a.join(' '));
  log('> ' + value);
}


function isWebBluetoothEnabled() {
  if (navigator.bluetooth) {
    return true;
  }
  else {
    log('Web Bluetooth API is not available.\n' +
      'Please make sure the Web Bluetooth flag is enabled.');
    return false;
  }
}

log = Logger.log;

document.querySelector('#startNotifications').addEventListener('click', function(event) {
  event.stopPropagation();
  event.preventDefault();

  if (isWebBluetoothEnabled()) {
    Logger.clearLog();
    onStartButtonClick();
  }
});

document.querySelector('#stopNotifications').addEventListener('click', function(event) {
  event.stopPropagation();
  event.preventDefault();

  if (isWebBluetoothEnabled()) {
    onStopButtonClick();
  }
});

</script>

</body>
</html>

